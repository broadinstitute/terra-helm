{{ $dashboardNamespaces := ((.Values.grafana.sidecar.dashboards).searchNamespace | default list) }}
{{ $datasourceNamespaces := ((.Values.grafana.sidecar.datasources).searchNamespace | default list) }}
{{ $notifierNamespaces := ((.Values.grafana.sidecar.notifiers).searchNamespace | default list) }}
{{ $namespaces := concat $dashboardNamespaces $datasourceNamespaces $notifierNamespaces | mustUniq}}

{{- range $_, $namespace := $namespaces}}
{{- if $.Values.sidecarFacilitation.createSearchedNamespaces }}
apiVersion: v1
kind: Namespace
metadata:
  name: {{ $namespace }}
  labels:
    {{- include "grafana.labels" $ | nindent 4 }}
---
{{- end }}
{{- if not (empty $.Values.sidecarFacilitation.grantUsersNamespaceAccess) }}
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: grafana-config-writer-role
  namespace: {{ $namespace }}
  labels:
    {{- include "grafana.labels" $ | nindent 4 }}
rules:
  - apiGroups: [""]
    resources:
      - configmaps
      - secrets
    verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: grafana-config-writer-rolebinding
  namespace: {{ $namespace }}
  labels:
    {{- include "grafana.labels" $ | nindent 4 }}
subjects:
{{- range $_, $user := $.Values.sidecarFacilitation.grantUsersNamespaceAccess }}
- kind: User
  name: {{ $user }}
  apiGroup: rbac.authorization.k8s.io
{{- end }}
roleRef:
  kind: Role
  name: grafana-config-writer-role
  apiGroup: rbac.authorization.k8s.io
---
{{- end }}
{{- end }}