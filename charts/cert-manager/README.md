# cert-manager

This is a wrapper chart for jetstack/cert-manager. It sets up a basic installation of cert-manager and then configures certificate 
issuers that can gnerate tester(invalid) and production (valid) tls through Let's Encrypt.

## Pre-Installation
This cert-manager deployment makes use of issuer resources which generate tls by solving dns challenges through gcp. A service account 
with dns-admin permissions for the gcp project which manages the domain certs are generated under.

The credentials for this service account should be stored in a k8s secret The name of this secret and the key for service account should be supplied 
as `secretName` and `secretKey` in values.yaml respectively. 

(Todo) add a flag to enable putting the dns service account credentials into a secret from vault via secrets-manager

## Installation

There is a script provided `install.sh` which will apply the necessary CRDS to a cluster and then run the helm command needed to install and configure cert-manager.

## Usage 

Certificates generated by cert-manager are managed using k8s resources with kind: Certificate. 
Cert-manager is able to detect these resources in any namespace throughout the cluster thus Certificate resources should be defined in the helm chart of the service
that uses a given certificate(s). 

For comprehensive details on the fields available to a Certificate resources please see the cert-manager [documentation](https://cert-manager.io/docs/usage/certificate/).

An example of a more common usage Certificate resources is:
```
apiVersion: certmanager.k8s.io/v1alpha1
kind: Certificate
metadata:
  name: example-cert
  namespace: example-service
spec:
  secretName: example-cert-secret
  renewBefore: 360h # Renew cert 15 days before exp
  dnsNames:
    - example.envs.broadinstitute.org
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
```

**Considerations**
+ Certificates will be valid for 3 months and have auto-renew on by default
+ dnsNames can be used to manage multiple dns records from a single certificate resource but please practice separation of concerns.
+ dns records created must be subdomains of envs.broadinstitute.org

Each cluster has 2 issuer resources configured one is named `letsencrypt-prod` and the other is `letsencrypt-staging`. If you require a valid tls certificates use the lets-encrypt prod issuer in your Certificate resource definition. IF you just need to test for the presence of a certificate and don't necessarily need valid tls, use lets-encrypt staging. 


If needed can look into configuring issuers for additional Certificate Authorities. 