# This step requires Config Connector to be installed in the cluster.
# The equivalent terraform-ap-modules/testrunner/dashboard.tf can be used
# in place of this manifest if Config Connector is not enabled.
{{- if and (.Values.secrets.gcpServiceAccount.workloadIdentity.enabled) (.Values.secrets.gcpServiceAccount.workloadIdentity.useConfigConnect) }}
---
# Will reference SA if it already exists, creates otherwise;
# we don't have control over that behavior.
# https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#authenticating_to
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMServiceAccount
metadata:
  name: {{ .Values.secrets.gcpServiceAccount.workloadIdentity.accountName }}
  labels: {{ include "testrunnerdashboard.labels" . | nindent 4 }}
---
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: {{ .Chart.Name }}-iampolicy-member
  labels: {{ include "testrunnerdashboard.labels" . | nindent 4 }}
spec:
  member: serviceAccount:{{ .Values.secrets.gcpServiceAccount.workloadIdentity.projectId }}.svc.id.goog[{{ .Release.Namespace }}/{{ .Values.global.name }}-sa]
  role: roles/iam.workloadIdentityUser
  resourceRef:
    apiVersion: iam.cnrm.cloud.google.com/v1beta1
    kind: IAMServiceAccount
    name: {{ .Values.secrets.gcpServiceAccount.workloadIdentity.accountName }}
---
{{- end }}
