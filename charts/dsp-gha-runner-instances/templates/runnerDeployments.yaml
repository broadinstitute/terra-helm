{{- range .Values.runners }}
{{ $defaultConfigValues := $.Values.runnerDefaults | default dict | deepCopy }}
{{ $dockerConfigValues := .dockerConfig | default $.Values.defaultDockerConfig | index $.Values.dockerConfigs | deepCopy }}
{{ $runnerConfigValues := .configOverrides | default dict }}
{{ $mergedConfigValues := $defaultConfigValues | mustMerge $dockerConfigValues | mustMerge $runnerConfigValues }}
{{ $configMetadata := index $mergedConfigValues "metadata" }}
{{ $configSpec := index $mergedConfigValues "spec" }}
---
apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: {{ .name }}
  labels: 
    {{- include "dsp-gha-runner-instances.labels" $ | nindent 4 }}
spec:
  template:
    metadata:
      {{ if $configMetadata }}
      {{- $configMetadata | toYaml | nindent 6 }}
      {{ end }}
    spec:
      repository: {{ .repository }}
      {{ if $configSpec }}
      {{- $configSpec | toYaml | nindent 6 }}
      {{ end }}
---
apiVersion: actions.summerwind.dev/v1alpha1
kind: HorizontalRunnerAutoscaler
metadata:
  name: {{ .name }}-autoscaler
  labels: 
    {{- include "dsp-gha-runner-instances.labels" $ | nindent 4 }}
spec:
  scaleTargetRef:
    name: {{ .name }}
  minReplicas: {{ .minReplicas | default $.Values.defaultMinReplicas }}
  maxReplicas: {{ .maxReplicas | default $.Values.defaultMaxReplicas }}
  metrics:
  - type: PercentageRunnersBusy
    scaleUpThreshold: '0.75'
    scaleDownThreshold: '0.3'
    scaleUpAdjustment: 2
    scaleDownAdjustment: 1
  scheduledOverrides:
  - startTime: {{ $.Values.weekendStart | quote }}
    endTime: {{ $.Values.weekendEnd | quote }}
    minReplicas: {{ .weekendMinReplicas | default $.Values.weekendMinReplicas }}
{{- end }}
