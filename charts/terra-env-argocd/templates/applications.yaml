{{- $terraEnv := .Values.environment }}
{{- /* Save root so it can be accessed inside the range */ -}}
{{- $root := . -}}
{{- range $terraApp, $configOverrides := .Values.apps -}}
{{- $appConfigs := merge $root.Values.private.appDefaults $configOverrides -}}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $terraApp }}-{{ $terraEnv }}
  labels:
    app: {{ $terraApp }} # These labels are used as selectors in the UI
    env: {{ $terraEnv }}
spec:
  project: {{ include "terra-env-argocd.projectName" $root }}
  destination:
    namespace: {{ include "terra-env-argocd.destinationNamespace" $root }}
    server: {{ include "terra-env-argocd.clusterAddress" $root }}
  source:
    repoURL: {{ $root.Values.helmfileRepo }}
    path: .
    plugin:
      name: helmfile-template
      env:
      - name: ENV
        value: {{ $terraEnv }}
      - name: SELECTOR
        value: name={{ $terraApp }}
{{- if $appConfigs.legacyConfigsEnabled }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $terraApp }}-configs-{{ $terraEnv }}
  labels:
    app: {{ $terraApp }} # These labels are used as selectors in the UI
    env: {{ $terraEnv }}
spec:
  project: {{ include "terra-env-argocd.projectName" $root }}
  destination:
    namespace: {{ include "terra-env-argocd.destinationNamespace" $root }}
    server: {{ include "terra-env-argocd.clusterAddress" $root }}
  source:
    repoURL: {{ $root.Values.legacyConfigsRepo }}
    targetRevision: {{ $root.Values.legacyConfigsRepoRef }}
    path: .
    plugin:
      name: legacy-firecloud-develop
      env:
      {{- $envVars := merge $appConfigs.legacyConfigsEnvVars (dict "ENV" $terraEnv "APP_NAME" $terraApp) -}}
      {{- range $name, $value := $envVars }}
      - name: {{ $name }}
        value: {{ $value }}
      {{- end -}}
{{- end -}}
{{- end -}}
