{{- with .Values -}}
{{- $projectName := include "terra-argocd.projectName" . -}}
{{- $namespace := include "terra-argocd.destinationNamespace" . -}}
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: {{ $projectName }}
spec:
  description: "Applications for Terra {{ .environment }} environment"
  destinations:
{{- range $clusterAddress := .clusterAddresses }}
  - namespace: {{ $namespace }}
    server: {{ $clusterAddress }}
{{- end }}
  sourceRepos:
  - "*"
  roles:
  - description: Edit privileges for all applications in {{ $projectName }}
    name: edit
    policies:
    - p, proj:{{ $projectName }}:edit, applications, *, {{ $projectName }}/*, allow
    groups:
    - local-suitable
    - broadinstitute:Workbench Admins
{{- if not .requireSuitable }}
    - local-notsuitable
    - broadinstitute:DSDE Engineering
{{- end }}
{{- end -}}
