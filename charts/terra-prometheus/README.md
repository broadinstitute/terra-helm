# terra-prometheus

a helm chart to deploy monitoring infrastructure

Putting the contents of the alermanager-conf.yaml here so it is version controlled.
If a change is made for now the vault value must be manually updated.

```
global:
  resolve_timeout: 5m
  slack_api_url: ${SLACK_WEBHOOK_URL}
route:
  group_by: ['job']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'slack'
  routes:
  - match:
      alertname: Watchdog
    receiver: 'null'
  - match:
    receiver: 'slack'
    continue: true
receivers:
- name: 'null'
- name: 'slack'
  slack_configs:
  - channel: '#terra-prometheus-alerts'
    send_resolved: true
    title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] Monitoring Event Notification'
    text: >-
      {{ range .Alerts }}
        *Alert:* {{ .Labels.severity }}
        *Description:* {{ .Annotations.message }}
        *Graph:* <{{ .GeneratorURL }}|:chart_with_upwards_trend:> *Runbook:* <{{ .Annotations.runbook }}|:spiral_note_pad:>
        *Details:*
        {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* {{ .Value }}
        {{ end }}
      {{ end }}
```

## Maintainers

| Name | Email | Url |
| ---- | ------ | --- |
| Michael Flinn | mflinn@broadinstitute.org |  |

## Source Code

* <https://github.com/broadinstitute/terra-helm/tree/master/charts>

## Requirements

| Repository | Name | Version |
|------------|------|---------|
| https://prometheus-community.github.io/helm-charts/ | kube-prometheus-stack | 9.3.4 |

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| certManager.dnsNames | list | `[]` |  |
| certManager.enabled | bool | `false` | (bool) Use tls credentials generated by cert-manager via lets encrypt |
| certManager.issuerKind | string | `"ClusterIssuer"` |  |
| certManager.issuerName | string | `"cert-manager-letsencrypt-prod"` | (string) Name of the Issuer or ClusterIssuer resource that will be used to obtain the tls certificate |
| certManager.renewBefore | string | `"720h"` | (string) Time before expiration when cert-manager will auto renew tls. Default is 30 days. Must be specified in hours |
| kube-prometheus-stack.fullnameOverride | string | `"terra-prometheus-operator"` |  |
| kube-prometheus-stack.namespaceOverride | string | `""` |  |
| kube-prometheus-stack.prometheus.ingress.annotations."kubernetes.io/ingress.allow-http" | string | `"false"` |  |
| kube-prometheus-stack.prometheus.ingress.annotations."kubernetes.io/ingress.global-static-ip-name" | string | `nil` |  |
| kube-prometheus-stack.prometheus.ingress.enabled | bool | `true` |  |
| kube-prometheus-stack.prometheus.ingress.hosts | list | `[]` |  |
| kube-prometheus-stack.prometheus.ingress.paths[0] | string | `"/*"` |  |
| kube-prometheus-stack.prometheus.ingress.tls[0].secretName | string | `"terra-prometheus-cert"` |  |
| kube-prometheus-stack.prometheus.prometheusSpec.containers | string | `nil` |  |
| kube-prometheus-stack.prometheus.prometheusSpec.evaluationInterval | string | `"60s"` |  |
| kube-prometheus-stack.prometheus.prometheusSpec.externalUrl | string | `nil` |  |
| kube-prometheus-stack.prometheus.prometheusSpec.scrapeInterval | string | `"60s"` |  |
| kube-prometheus-stack.prometheus.service.annotations."cloud.google.com/backend-config" | string | `nil` |  |
| kube-prometheus-stack.prometheus.service.type | string | `"NodePort"` |  |
| kube-prometheus-stack.prometheusOperator.createCustomResource | bool | `false` |  |
| namespaceOverride | string | `""` | (string) enables installing to monitoring namespace when deployed as dependency via argoCd |
| prometheusRuleSelector | string | `"prometheus-operator"` | (string) used to create a label that prometheus selcts to determine which rules to alert on |
| prometheusToSD.imageRepo | string | `"gcr.io/google-containers/prometheus-to-sd"` | (string) image repo for prometheus-to-sd-exporter |
| prometheusToSD.imageTag | string | `"v0.5.2"` | (string) image tag for prometheus-to-sd-exporter |
| prometheusToSD.metricsSources | object | `{}` | (object) map of prometheus scrape targets to export to SD |
| prometheusToSD.monitoredResourceTypes | string | `"k8s"` | (string) used internally by stackdriver, don't change this |
| prometheusToSD.replicaCount | int | `1` | (int) number of prometheus-to-sd replicas to run |
| resourceValidator.ignore | bool | `false` | (bool) flag to modify the cronjob alert query to ignore failures of Leonardo's resource-validator. |
| vaultCert.cert.path | string | `nil` | Path to secret containing .crt |
| vaultCert.cert.secretKey | string | `nil` | Key in secret containing .crt |
| vaultCert.chain.path | string | `nil` | Path to secret containing intermediate .crt |
| vaultCert.chain.secretKey | string | `nil` | Key in secret containing intermediate .crt |
| vaultCert.enabled | bool | `false` | Enable to sync certificate secret from Vault with secrets-manager |
| vaultCert.key.path | string | `nil` | Path to secret containing .key |
| vaultCert.key.secretKey | string | `nil` | Key in secret containing .key |
