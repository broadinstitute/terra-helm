terra-prometheus
================
a helm chart to deploy monitoring infrastructure

Current chart version is `0.1.1`

Prometheus maintainers are adamant that alertmanager must read config from files
and that those configs do not support reading in values from env vars.
this makes it so that is not possible to inject a secret like a slack webhook
into the config with out a supplemental templating layer which we currently don't have.

As temporary workaround the alertmanager config yaml is stored
entirely as a b64 encoded string in vault at secret/devops/prometheus/alertmanager/config
and mounted as a file to alertmanager
The prometheus operator currently has an alpha feature to support templating alert manager 
configs via crd but it doesn't support slack yet. 

Putting the contents of the alermanager-conf.yaml here so it is version controlled. 
If a change is made for now the vault value must be manually updated.
```
global:
  resolve_timeout: 5m
  slack_api_url: ${SLACK_WEBHOOK_URL}
route:
  group_by: ['job']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'slack'
  routes:
  - match:
      alertname: Watchdog
    receiver: 'null'
  - match:
    receiver: 'slack'
    continue: true
receivers:
- name: 'null'
- name: 'slack'
  slack_configs:
  - channel: '#terra-prometheus-alerts'
    send_resolved: true
    title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] Monitoring Event Notification'
    text: >-
      {{ range .Alerts }}
        *Alert:* `{{ .Labels.severity }}`
        *Description:* {{ .Annotations.message }}
        *Graph:* <{{ .GeneratorURL }}|:chart_with_upwards_trend:> *Runbook:* <{{ .Annotations.runbook }}|:spiral_note_pad:>
        *Details:*
        {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
        {{ end }}
      {{ end }}
```
## Chart Requirements

| Repository | Name | Version |
|------------|------|---------|
| https://kubernetes-charts.storage.googleapis.com/ | prometheus-operator | 8.15.6 |

## Chart Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| certManager.dnsNames | list | `[]` |  |
| certManager.enabled | bool | `false` | (bool) Use tls credentials generated by cert-manager via lets encrypt |
| certManager.issuerKind | string | `"ClusterIssuer"` |  |
| certManager.issuerName | string | `"cert-manager-letsencrypt-prod"` | (string) Name of the Issuer or ClusterIssuer resource that will be used to obtain the tls certificate |
| certManager.renewBefore | string | `"720h"` | (string) Time before expiration when cert-manager will auto renew tls. Default is 30 days. Must be specified in hours |
| namespaceOverride | string | `""` | (string) enables installing to monitoring namespace when deployed as dependency via argoCd |
| prometheus-operator.fullnameOverride | string | `"terra-prometheus-operator"` |  |
| prometheus-operator.namespaceOverride | string | `""` | (string) For use with argocd to ensure prometheus resources are installed to monitoring namespace |
| prometheus-operator.prometheus.ingress.annotations | object | `{"kubernetes.io/ingress.allow-http":"false","kubernetes.io/ingress.global-static-ip-name":null}` | annotations to attache to prometheus ingress resource. |
| prometheus-operator.prometheus.ingress.enabled | bool | `true` | expose prometheus web ui through gke ingress |
| prometheus-operator.prometheus.ingress.hosts | list | `[]` | ([string]) List of domain host(s) that the ingress should be accessible from  |
| prometheus-operator.prometheus.ingress.paths[0] | string | `"/*"` |  |
| prometheus-operator.prometheus.ingress.tls | list | `[{"secretName":"terra-prometheus-cert"}]` | ([string]) List of k8s secret names containing tls credentials. |
| prometheus-operator.prometheus.prometheusSpec.containers | [object] | `nil` | Used to inject the stackdriver exporter into prometheus pods. |
| prometheus-operator.prometheus.prometheusSpec.externalUrl | string | `nil` | URL at which prometheus UI will be available. |
| prometheus-operator.prometheus.service.annotations | object | `{"cloud.google.com/backend-config":null}` | (object) Used for attaching backend-config resources to prometheus service  |
| prometheus-operator.prometheus.service.type | string | `"NodePort"` | (string) Service type for prometheus, must be NodePort for ingress to work. |
| prometheus-operator.prometheusOperator.createCustomResource | bool | `false` |  |
| vaultCert.cert.path | string | `nil` | Path to secret containing .crt |
| vaultCert.cert.secretKey | string | `nil` | Key in secret containing .crt |
| vaultCert.chain.path | string | `nil` | Path to secret containing intermediate .crt |
| vaultCert.chain.secretKey | string | `nil` | Key in secret containing intermediate .crt |
| vaultCert.enabled | bool | `false` | Enable to sync certificate secret from Vault with secrets-manager |
| vaultCert.key.path | string | `nil` | Path to secret containing .key |
| vaultCert.key.secretKey | string | `nil` | Key in secret containing .key |
