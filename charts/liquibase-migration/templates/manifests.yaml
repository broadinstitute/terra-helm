{{- range .Values.enumerated }}

{{- $config := $.Values.defaults | deepCopy | mustMerge . }}

{{- if $config.enabled }}

{{- /*
Imperative defaults that can't exist in the Values file
*/}}
{{- if not (hasKey $config "migrationImageTag") }}
  {{- if not (($.Values.global).applicationVersion) }}
    {{- fail ".Values.global.applicationVersion not set, so migrationImageTag must be passed"}}
  {{- end }}
  {{- $_ := set $config "migrationImageTag" $.Values.global.applicationVersion }}
{{- end }}
{{- if not (hasKey $config "k8sAppName") }}
  {{- $_ := set $config "k8sAppName" $.Release.Name }}
{{- end }}
{{- if not (hasKey $config "k8sLabelRef") }}
  {{- $_ := set $config "k8sLabelRef" (printf "%s.labels" $config.k8sAppName) }}
{{- end }}
{{- if not (hasKey $config "k8sServiceAccount") }}
  {{- $_ := set $config "k8sServiceAccount" (printf "%s-sa" $config.k8sAppName) }}
{{- end }}

{{- /*
Imperative validation for gotchas
*/}}
{{- if and (not ((($config.migrationDatabaseCredentials).fromVaultSecret).path)) (not ((($config.migrationDatabaseCredentials).existingKubernetesSecret).name)) }}
  {{- fail "Either migrationDatabaseCredentials.fromVaultSecret or migrationDatabaseCredentials.existingKubernetesSecret must be provided" }}
{{- end }}

{{- /*
Create secret for database credentials if required
*/}}
{{- if and ((($config.migrationDatabaseCredentials).fromVaultSecret).path) (not ((($config.migrationDatabaseCredentials).existingKubernetesSecret).name)) }}
apiVersion: secrets-manager.tuenti.io/v1alpha1
kind: SecretDefinition
metadata:
  name: {{ $config.name | required "Name is required" }}-migration-secretdef
  {{- if $config.k8sLabelRef }}
  labels: {{- include $config.k8sLabelRef $ | nindent 4 }}
  {{- end }}
  annotations:
    argocd.argoproj.io/sync-wave: {{ $config.k8sSyncWave | quote }}
spec:
  name: {{ $config.name }}-migration-sql-secrets
  keysMap:
    db-username:
      key: {{ $config.migrationDatabaseCredentials.fromVaultSecret.usernameKey | required "fromVaultSecret.usernameKey required if using Vault" }}
      path: {{ $config.migrationDatabaseCredentials.fromVaultSecret.path }}
      encoding: text
    db-password:
      key: {{ $config.migrationDatabaseCredentials.fromVaultSecret.passwordKey | required "fromVaultSecret.passwordKey required if using Vault" }}
      path: {{ $config.migrationDatabaseCredentials.fromVaultSecret.path }}
      encoding: text
    {{- if $config.migrationDatabaseCredentials.fromVaultSecret.variableDatabaseKey }}
    db-name:
      key: {{ $config.migrationDatabaseCredentials.fromVaultSecret.variableDatabaseKey }}
      path: {{ $config.migrationDatabaseCredentials.fromVaultSecret.path }}
      encoding: text
    {{- end }}
---
{{- end }}

{{- /*
Create migration job
*/}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $config.name }}-liquibase-migration
  {{- if $config.k8sLabelRef }}
  labels: {{- include $config.k8sLabelRef $ | nindent 4 }}
  {{- end }}
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: {{ $config.k8sSyncWave | quote }}
spec:
  backoffLimit: 2
  template:
    metadata:
      name: {{ $config.name }}-liquibase-migration
      {{- if $config.k8sLabelRef }}
      labels: {{- include $config.k8sLabelRef $ | nindent 8 }}
      {{- end }}
    spec:
      # Allow migration-liquibase to kill migration-sqlproxy's process
      shareProcessNamespace: true
      restartPolicy: Never
      serviceAccountName: {{ $config.k8sServiceAccount }}
      # Most apps reference "127.0.0.1" in DB URL but some expect "sqlproxy"
      hostAliases:
      - ip: 127.0.0.1
        hostnames:
        - sqlproxy
      {{- if or (($config.proxyCredentialFileMount).secretName) (($config.migrationConfigFileMount).secretName) }}
      volumes:
      {{- if (($config.proxyCredentialFileMount).secretName) }}
      - name: proxy-credentials-volume
        secret:
          secretName: {{ $config.proxyCredentialFileMount.secretName }}
      {{- end }}
      {{- if (($config.migrationConfigFileMount).secretName) }}
      - name: migration-configs-volume
        secret:
          secretName: {{ $config.migrationConfigFileMount.secretName }}
      {{- end }}
      {{- end }}
      containers:
      - name: {{ $config.name }}-migration-sqlproxy
        image: {{ $config.proxyImage }}:{{ $config.proxyImageTag }}
        {{- if (($config.proxyCredentialFileMount).secretName) }}
        volumeMounts:
        - mountPath: {{ $config.proxyCredentialFileMount.mountFilePath | required "proxyCredentialFileMount.mountFilePath required if proxyCredentialFileMount.secretName provided" }}
          subPath: {{ $config.proxyCredentialFileMount.mountFilePath | splitList "/" | last }}
          name: proxy-credentials-volume
          readOnly: true
        {{- end }}
        {{- if $config.proxyContainerConfig }}
        {{- $config.proxyContainerConfig | toYaml | nindent 8 }}
        {{- end }}
        command: {{ $config.proxyShell | toYaml | nindent 10 }}
        args:
        - |-
          /cloud_sql_proxy \
            -verbose \
            -max_connections={{ $config.proxyArgsMaxConnections }} \
            -instances={{ $config.proxyArgsInstances }} \
            {{- if (($config.proxyCredentialFileMount).secretName) }}
            -credential_file={{ $config.proxyCredentialFileMount.mountFilePath }} \
            {{- end }}
      - name: {{ $config.name }}-migration-liquibase
        image: {{ $config.migrationImage | required "migrationImage required" }}:{{ $config.migrationImageTag }}
        {{- if (($config.migrationConfigFileMount).secretName) }}
        volumeMounts:
        - mountPath: {{ $config.migrationConfigFileMount.mountFilePath | required "migrationConfigFileMount.mountFilePath required if migrationConfigFileMount.secretName provided" }}
          subPath: {{ $config.migrationConfigFileMount.mountFilePath | splitList "/" | last }}
          name: migration-configs-volume
          readOnly: true
        {{- end }}
        env:
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              {{- if and ((($config.migrationDatabaseCredentials).fromVaultSecret).path) (not ((($config.migrationDatabaseCredentials).existingKubernetesSecret).name)) }}
              name: {{ $config.name }}-migration-sql-secrets
              key: db-username
              {{- end }}
              {{- if ((($config.migrationDatabaseCredentials).existingKubernetesSecret).name) }}
              name: {{ $config.migrationDatabaseCredentials.existingKubernetesSecret.name }}
              key: {{ $config.migrationDatabaseCredentials.existingKubernetesSecret.usernameKey | required "existingKubernetesSecret.usernameKey required if existingKubernetesSecret.name passed" }}
              {{- end }}
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              {{- if and ((($config.migrationDatabaseCredentials).fromVaultSecret).path) (not ((($config.migrationDatabaseCredentials).existingKubernetesSecret).name)) }}
              name: {{ $config.name }}-migration-sql-secrets
              key: db-password
              {{- end }}
              {{- if ((($config.migrationDatabaseCredentials).existingKubernetesSecret).name) }}
              name: {{ $config.migrationDatabaseCredentials.existingKubernetesSecret.name }}
              key: {{ $config.migrationDatabaseCredentials.existingKubernetesSecret.passwordKey | required "existingKubernetesSecret.passwordKey required if existingKubernetesSecret.name passed" }}
              {{- end }}
        {{- if or ((($config.migrationDatabaseCredentials).fromVaultSecret).variableDatabaseKey) ((($config.migrationDatabaseCredentials).existingKubernetesSecret).variableDatabaseKey) }}
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              {{- if and ((($config.migrationDatabaseCredentials).fromVaultSecret).path) (not ((($config.migrationDatabaseCredentials).existingKubernetesSecret).name)) }}
              name: {{ $config.name }}-migration-sql-secrets
              key: db-name
              {{- end }}
              {{- if ((($config.migrationDatabaseCredentials).existingKubernetesSecret).name) }}
              name: {{ $config.migrationDatabaseCredentials.existingKubernetesSecret.name }}
              key: {{ $config.migrationDatabaseCredentials.existingKubernetesSecret.variableDatabaseKey }}
              {{- end }}
        {{- end }}
        command: {{ $config.migrationShell | toYaml | nindent 10 }}
        args:
        - |-
          {{- if $config.migrationDelay }}
          sleep {{ $config.migrationDelay }} && \
          {{- end }}
          java -cp {{ $config.migrationArgsClasspath | required "Classpath required" | mustUniq | mustCompact | join ":" | quote }} liquibase.integration.commandline.Main \
            --username="$DB_USERNAME" \
            --password="$DB_PASSWORD" \
            {{- if (($config.migrationConfigFileMount).secretName) }}
            --defaultsFile={{ $config.migrationConfigFileMount.mountFilePath }} \
            {{- end }}
            {{- if $config.migrationArgsConfigChangelog }}
            --changeLogFile={{ $config.migrationArgsConfigChangelog }} \
            {{- end }}
            {{- if $config.migrationArgsConfigDriver }}
            --driver={{ $config.migrationArgsConfigDriver }} \
            {{- end }}
            {{- if $config.migrationArgsConfigUrl }}
            --url={{ $config.migrationArgsConfigUrl }} \
            {{- end }}
            {{- if $config.migrationsArgsAdditional }}
            {{ $config.migrationsArgsAdditional }} \
            {{- end }}
            {{ $config.migrationArgsLiquibaseCommand }}; \
          EXIT=$?; \
          pkill -SIGTERM cloud_sql_proxy; \
          exit $EXIT
---
{{- end }}

{{- end }}
