# dsp-cert-manager

![Version: 2.2.0](https://img.shields.io/badge/Version-2.2.0-informational?style=flat-square) ![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square)

Installs cert-manager, configures psps and creates Let's encrypt cluster issuers

This is a wrapper chart for jetstack/cert-manager. It sets up a basic installation of cert-manager and then configures certificate
issuers that can gnerate tester(invalid) and production (valid) tls through Let's Encrypt.

## Maintainers

| Name | Email | Url |
| ---- | ------ | --- |
| DSP DevOps | dsp-devops@broadinstitute.org |  |

## Source Code

* <https://github.com/broadinstitute/terra-helm/tree/master/charts>

## Requirements

| Repository | Name | Version |
|------------|------|---------|
| https://charts.jetstack.io | cert-manager | v1.4 |

## Pre-installation

You will need to apply CRDs manually, per [docs here](https://cert-manager.io/docs/installation/helm/#option-1-installing-crds-with-kubectl).

Cert-manager requires GCP permissions to create DNS records. A GCP SA can be provided either via workload identity
or via a key added to a Kubernetes secret, see below.

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| cert-manager.extraArgs[0] | string | `"--enable-certificate-owner-ref=true"` |  |
| cert-manager.global.podSecurityPolicy.enabled | bool | `true` |  |
| dnsProject.id | string | `nil` | ID of the project to create DNS records in, like dsp-devops |
| dnsProject.serviceAccount | object | `{"secretKey":null,"secretName":null}` | If not using workload identity, a GCP SA's private key must exist in a k8s secret |
| dnsProject.serviceAccount.secretKey | string | `nil` | Field within the k8s secret containing a GCP SA key |
| dnsProject.serviceAccount.secretName | string | `nil` | Name of the k8s secret containing a GCP SA key |
| dnsProject.workloadIdentity | bool | `true` | If true, have cert-manager expect a GCP SA to be bound to its KSA via workload identity (set the workload identity annotation via cert-manager.serviceAccount.annotations) |
| issuerAccountEmail | string | `"dsp-devops@broadinstitute.org"` |  |

## Usage

Certificates generated by cert-manager are managed using k8s resources with kind: Certificate.
Cert-manager is able to detect these resources in any namespace throughout the cluster thus Certificate resources should be defined in the helm chart of the service
that uses a given certificate(s).

For comprehensive details on the fields available to a Certificate resources please see the cert-manager [documentation](https://cert-manager.io/docs/usage/certificate/).

An example of a more common usage Certificate resources is:
```
apiVersion: certmanager.k8s.io/v1alpha1
kind: Certificate
metadata:
  name: example-cert
  namespace: example-service
spec:
  secretName: example-cert-secret
  renewBefore: 360h # Renew cert 15 days before exp
  dnsNames:
    - example.envs.broadinstitute.org
  issuerRef:
    name: cert-manager-letsencrypt-prod
    kind: ClusterIssuer
```

**Considerations**
+ Certificates will be valid for 3 months and have auto-renew on by default
+ dnsNames can be used to manage multiple dns records from a single certificate resource but please practice separation of concerns.
+ dns records created must be subdomains of envs.broadinstitute.org

Each cluster has 2 issuer resources configured one is named `letsencrypt-prod` and the other is `letsencrypt-staging`. If you require a valid tls certificates use the lets-encrypt prod issuer in your Certificate resource definition. IF you just need to test for the presence of a certificate and don't necessarily need valid tls, use lets-encrypt staging.

If needed can look into configuring issuers for additional Certificate Authorities.
