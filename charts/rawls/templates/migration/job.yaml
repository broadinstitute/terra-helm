{{- if .Values.migration.enabled }}
{{- $imageTag := .Values.migration.imageTag | default .Values.global.applicationVersion -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: rawls-liquibase-migration
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocr.argoproj.io/hook-delete-policy: BeforeHookCreation
  labels: 
    {{- include "rawls.labels" . | nindent 4 }}
spec:
  backoffLimit: 2
  template:
    metadata:
      name: rawls-liquibase-migration
      labels:
        {{- include "rawls.labels" . | nindent 8 }}
    spec:
      # Allow migration-liquibase to kill migration-sqlproxy's process
      shareProcessNamespace: true
      restartPolicy: Never
      serviceAccountName: rawls-migration-sa
      hostAliases:
      - ip: 127.0.0.1
        hostnames:
        - sqlproxy
      volumes:
      - name: sqlproxy-ctmpls
        secret:
          secretName: {{ .Values.migration.sqlProxySecretPrefix }}-sqlproxy-ctmpls
      containers:
      - name: migration-liquibase
        image: "gcr.io/broad-dsp-gcr-public/rawls:{{ $imageTag }}"
        command: ['bash', '-c']
        # Sleep for 15s to allow CloudSQL proxy time to start up. See DDO-1284 / BT-296
        # The `find /rawls -name 'rawls*.jar'` is from Rawls's own Dockerfile CMD
        # The `--driver` is the underlying JDBC driver, e.g. not Slick, see https://doc.akka.io/docs/alpakka/current/slick.html#artifacts
        # The `--url` is hardcoded pending DDO-1297
        # Command is a no-op `updateSQL` during development
        args:
        - |-
          sleep 15 && \
          java -cp $(find /rawls -name 'rawls*.jar') liquibase.integration.commandline.Main \
            --driver='com.mysql.jdbc.Driver' \
            --classpath="$(find /rawls -name 'rawls*.jar')" \
            --changeLogFile='org/broadinstitute/dsde/rawls/liquibase/changelog.xml' \
            --url="$DB_URL" \
            --username="$DB_USERNAME" \
            --password="$DB_PASSWORD" \
            updateSQL; \
          EXIT=$?; \
          pkill -SIGTERM cloud_sql_proxy; \
          exit $EXIT
        env:
        - name: DB_URL
          value: {{ .Values.migration.dbUrl }}
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: rawls-sql-secrets
              key: db-username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: rawls-sql-secrets
              key: db-password
      - name: migration-sqlproxy
        image: broadinstitute/cloudsqlproxy:1.11_20180808
        envFrom:
        - secretRef:
            name: {{ .Values.migration.sqlProxySecretPrefix }}-sqlproxy-env
        volumeMounts:
        - mountPath: /etc/sqlproxy-service-account.json
          subPath: sqlproxy-service-account.json
          name: sqlproxy-ctmpls
          readOnly: true
{{- end -}}
